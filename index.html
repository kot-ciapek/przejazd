<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Licytacja miejsc na przejazd — HTML + Stripe (demo)</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--muted:#64748b;--accent:#4f46e5;--success:#16a34a;--danger:#ef4444}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background:var(--bg); margin:0;padding:24px;color:#0f172a}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.06);}    
    form .row{display:flex;gap:8px}
    input,button,select,textarea{padding:10px;border-radius:10px;border:1px solid #e6edf3}
    input{flex:1}
    button{background:var(--accent);color:#fff;border:none;cursor:pointer}
    .grid{display:grid;gap:12px;margin-top:12px}
    .seat{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:12px;background:#fff}
    .seat .left{flex:1}
    .muted{color:var(--muted);font-size:13px}
    .status{font-weight:700}
    .timer{background:#fff3f2;color:var(--danger);padding:6px 10px;border-radius:999px;font-family:monospace}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:13px}
    .pill{background:#f1f5f9;padding:6px 10px;border-radius:999px}
    .ghost{background:#f3f4f6;color:#111;border:0}
    .success{background:var(--success);color:white}
    .yellow{background:#f59e0b;color:white}
    .inline{display:inline-block}
    .err{color:var(--danger)}

    /* modal */
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:50}
    .login-box{background:white;padding:20px;border-radius:12px;max-width:420px;width:100%;box-shadow:0 8px 30px rgba(2,6,23,0.3)}

    @media (max-width:700px){.seat{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Licytacja miejsc w aucie — (wersja HTML)</h1>
        <div class="muted small">Proszę nie robić sobie żartów z tej strony — używaj odpowiedzialnie.</div>
      </div>
      <div style="text-align:right">
        <div id="userInfo" class="muted small">Nie zalogowano</div>
        <div id="adminNotice" class="muted small" style="display:none">Jesteś administratorem</div>
      </div>
    </header>

    <section id="addSection" class="card">
      <h2 style="margin:0 0 8px 0;font-size:16px">Dodaj miejsce</h2>
      <form id="addForm">
        <div class="row">
          <input id="seatName" placeholder="Nazwa miejsca (np. tylne lewe)" />
          <input id="basePrice" type="number" min="0" value="10" style="width:120px" />
          <input id="duration" type="number" min="0.1" step="0.1" value="2" style="width:120px" />
          <button id="addBtn">Dodaj</button>
        </div>
        <div class="muted small" style="margin-top:8px">Cena wywoławcza (zł) • Czas trwania (minuty)</div>
        <div id="addErr" class="err small" style="margin-top:6px"></div>
      </form>
    </section>

    <section id="list" class="grid" style="margin-top:16px"></section>

    <footer style="margin-top:14px" class="muted small">Płatności (demo) przez Stripe Checkout (BLIK/inna metoda) — wymaga backendu. Możesz podłączyć własny provider.</footer>
  </div>

  <!-- Login modal (wymagane na początku) -->
  <div id="loginOverlay" class="overlay">
    <div class="login-box">
      <h3 style="margin:0 0 8px 0">Wpisz swoje imię i nazwisko</h3>
      <form id="loginForm">
        <div style="display:flex;gap:8px">
          <input id="firstName" placeholder="Imię" />
          <input id="lastName" placeholder="Nazwisko" />
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button type="submit">Zaloguj</button>
          <button type="button" id="guestBtn" class="ghost">Kontynuuj jako gość</button>
        </div>
        <div class="muted small" style="margin-top:8px">Twoje dane będą używane lokalnie — to demo.</div>
      </form>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'car_seat_auctions_html_v1_v3';
    const USER_KEY = 'car_seat_user_v1';

    // If you want cross-machine sync, run a backend that exposes /seats (GET/POST) and /create-checkout-session
    // This frontend will try to talk to that backend; if it isn't available it'll fall back to localStorage.

    function escapeHtml(str){ return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    // --- AUTH / user handling ---
    function getCurrentUser(){ try{ return JSON.parse(localStorage.getItem(USER_KEY) || 'null'); }catch(e){ return null; }}
    function setCurrentUser(u){ localStorage.setItem(USER_KEY, JSON.stringify(u)); }
    function clearCurrentUser(){ localStorage.removeItem(USER_KEY); }
    function isAdmin(user){ if(!user) return false; return (String(user.first||'').toLowerCase() === 'tylko' && String(user.last||'').toLowerCase() === 'przejazd'); }

    // --- seats storage ---
    async function loadSeatsLocal(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return sampleSeats(); return JSON.parse(raw);}catch(e){ return sampleSeats(); }}
    function sampleSeats(){ return [ { id:1, title:'Miejsce 1 — tylne prawe', basePrice:10, durationSec:120, status:'ready', highestBid:0, highestBidder:null, endTime:null}, { id:2, title:'Miejsce 2 — przednie', basePrice:15, durationSec:120, status:'ready', highestBid:0, highestBidder:null, endTime:null} ]; }

    let seats = [];
    const listEl = document.getElementById('list');

    function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(seats)); }

    function formatTimeLeft(endTime){ if(!endTime) return ''; const left = Math.max(0, Math.round((endTime - Date.now())/1000)); const mm = String(Math.floor(left/60)).padStart(2,'0'); const ss = String(left%60).padStart(2,'0'); return `${mm}:${ss}`; }
    function nextMinBid(seat){ return Math.max(seat.basePrice, seat.highestBid || 0) + 1; }

    // Try to fetch seats from server. If server responds, replace local copy and saveLocal.
    async function fetchSeatsFromServer(){
      try{
        const res = await fetch('/seats');
        if(!res.ok) throw new Error('no server');
        const remote = await res.json();
        seats = remote;
        saveLocal();
        render();
        return true;
      }catch(e){ return false; }
    }

    // Try to push local seats to server (POST /seats). Returns true on success.
    async function pushSeatsToServer(){
      try{
        const res = await fetch('/seats', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(seats) });
        if(!res.ok) throw new Error('push failed');
        return true;
      }catch(e){ return false; }
    }

    // render + controls
    function render(){
      const now = Date.now();
      seats = seats.map(s => (s.status==='ongoing' && s.endTime && now>=s.endTime) ? ({...s,status:'ended'}) : s);
      saveLocal();

      const user = getCurrentUser();
      const admin = isAdmin(user);

      // user info
      const userInfo = document.getElementById('userInfo');
      const adminNotice = document.getElementById('adminNotice');
      if(user){ userInfo.textContent = `Zalogowany: ${user.first} ${user.last}`; } else { userInfo.textContent = 'Nie zalogowano'; }
      adminNotice.style.display = admin ? 'block' : 'none';

      // add section access
      const addSection = document.getElementById('addSection');
      const addErr = document.getElementById('addErr');
      addErr.textContent = '';
      if(!admin){ addSection.style.opacity = '0.6'; document.getElementById('addBtn').disabled = true; } else { addSection.style.opacity = '1'; document.getElementById('addBtn').disabled = false; }

      listEl.innerHTML = '';
      if(seats.length===0){ listEl.innerHTML = '<div class="muted">Brak miejsc. Dodaj nowe miejsce powyżej.</div>'; return; }

      seats.forEach(seat=>{
        const el = document.createElement('div'); el.className='seat card';
        el.innerHTML = `
          <div class="left">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">${escapeHtml(seat.title)}</div>
            </div>
            <div class="muted small" style="margin-top:6px">Cena wywoławcza: <strong>${seat.basePrice} zł</strong></div>
            <div style="margin-top:8px">${renderStatus(seat)}</div>
            <div style="margin-top:8px;background:#f8fafc;padding:8px;border-radius:10px;font-size:14px">Aktualna najwyższa oferta: <strong>${seat.highestBid?seat.highestBid+' zł':'-'}</strong><div class="muted small">Zwycięzca/obecny licytant: ${escapeHtml(seat.highestBidder) || '-'}</div></div>
            <div class="controls" style="margin-top:10px">${renderControls(seat, admin)}</div>
          </div>
          <div style="width:220px;text-align:right">
            <div class="muted small">Czas trwania: ${(seat.durationSec/60).toFixed(1)} min</div>
            <div style="margin-top:12px;background:#f1f5f9;padding:10px;border-radius:10px;font-weight:700;text-transform:uppercase">${seat.status}</div>
          </div>
        `;

        listEl.appendChild(el);

        const startBtn = el.querySelector('[data-start]'); if(startBtn) startBtn.addEventListener('click', ()=>startAuction(seat.id));
        const relistBtn = el.querySelector('[data-relist]'); if(relistBtn) relistBtn.addEventListener('click', ()=>relistSeat(seat.id,60));
        const resetBtn = el.querySelector('[data-reset]'); if(resetBtn) resetBtn.addEventListener('click', ()=>{ resetSeat(seat.id); render(); });
        const payBtn = el.querySelector('[data-pay]'); if(payBtn) payBtn.addEventListener('click', ()=>startPayment(seat.id));
        const editBtn = el.querySelector('[data-edit]'); if(editBtn) editBtn.addEventListener('click', ()=>editSeat(seat.id));
        const durationBtn = el.querySelector('[data-duration]'); if(durationBtn) durationBtn.addEventListener('click', ()=>changeDurationPrompt(seat.id));
        const bidForm = el.querySelector('form'); if(bidForm) bidForm.addEventListener('submit', ev=>{ ev.preventDefault(); const name = bidForm.querySelector('[name="bidder"]').value.trim(); const amount = Number(bidForm.querySelector('[name="amount"]').value); const errEl = bidForm.querySelector('.err'); placeBid(seat.id, name, amount, errEl); });
      });
    }

    function renderStatus(seat){ if(seat.status==='ready') return `<span class="pill">Gotowe do startu</span>`; if(seat.status==='ongoing') return `<span class="timer">${formatTimeLeft(seat.endTime)}</span>`; if(seat.status==='ended') return `<span class="pill" style="background:#ecfccb;color:#4b7f1a">Zakończone</span>`; return ''; }

    function renderControls(seat, isAdmin){
      if(seat.status==='ready'){
        // only admin may start and edit
        if(isAdmin){
          return `<button data-start class="">Start licytacji</button> <button data-edit class="inline ghost">Edytuj</button> <button data-duration class="inline ghost">Zmień czas</button>`;
        }
        return `<button class="ghost" disabled title="Tylko admin może uruchamiać licytacje">Start (tylko admin)</button>`;
      }
      if(seat.status==='ongoing'){
        const defaultAmount = nextMinBid(seat);
        return `<form class="row" style="margin-top:6px">
            <input name="bidder" placeholder="Twoje imię/id" style="flex:1" />
            <input name="amount" type="number" min="${defaultAmount}" value="${defaultAmount}" style="width:110px" />
            <button type="submit" class="success">Licytuj</button>
            <div class="err muted small" style="width:100%"></div>
          </form>`;
      }
      // seat.status === 'ended' — pokaż przycisk płatności do zapłacenia przez zwycięzcę
      return `<div class="small">Wygrał: <strong>${escapeHtml(seat.highestBidder) || '—'}</strong> za <strong>${seat.highestBid?seat.highestBid+' zł':'—'}</strong>
        <div style="margin-top:6px">
          <button data-pay class="success">Zapłać (Stripe Checkout)</button>
          <button data-relist class="yellow">Wystaw ponownie (+60s)</button>
          <button data-reset class="ghost">Resetuj</button>
        </div></div>`;
    }

    async function startAuction(id){ const user = getCurrentUser(); if(!isAdmin(user)){ alert('Tylko administrator może uruchamiać licytacje'); return; } seats = seats.map(s => s.id===id ? ({...s, status:'ongoing', endTime: Date.now() + s.durationSec*1000, highestBid: s.highestBid || s.basePrice}) : s); saveLocal(); await pushSeatsToServer(); render(); }
    async function relistSeat(id, extraSec=60){ seats = seats.map(s => s.id===id ? ({...s, status:'ongoing', endTime: Date.now() + extraSec*1000, highestBid: s.highestBid || s.basePrice}) : s); saveLocal(); await pushSeatsToServer(); render(); }
    async function resetSeat(id){ seats = seats.map(s => s.id===id ? ({...s, status:'ready', highestBid:0, highestBidder:null, endTime:null}) : s); saveLocal(); await pushSeatsToServer(); render(); }

    // Anti-sniping: jeśli oferta wpłynie w ostatnich 10s, wydłuż o 15s
    const SNIP_PROTECT_WINDOW_MS = 10_000;
    const SNIP_EXTENSION_MS = 15_000;

    async function placeBid(id, bidderName, amount, errEl){ if(!bidderName){ if(errEl) errEl.textContent='Podaj swoje imię/id'; return; } if(!Number.isFinite(amount) || amount <= 0){ if(errEl) errEl.textContent='Podaj poprawną kwotę'; return; }
      let updated=false; const now = Date.now(); seats = seats.map(s => { if(s.id!==id) return s; const min = Math.max(s.basePrice, s.highestBid || 0) + 1; if(amount < min){ if(errEl) errEl.textContent = `Kwota za mała — minimalnie ${min} zł`; return s; } let newEnd = s.endTime; if(s.status==='ongoing' && s.endTime && (s.endTime - now) <= SNIP_PROTECT_WINDOW_MS){ newEnd = s.endTime + SNIP_EXTENSION_MS; } updated = true; if(errEl) errEl.textContent = ''; return {...s, highestBid: amount, highestBidder: bidderName, endTime: newEnd, status:'ongoing'}; }); if(updated){ saveLocal(); await pushSeatsToServer(); render(); } }

    // Allow admin to edit title/base/duration before starting or even after
    async function editSeat(id){ const user = getCurrentUser(); if(!isAdmin(user)){ alert('Tylko administrator może edytować aukcje'); return; } const seat = seats.find(s=>s.id===id); if(!seat) return; const title = prompt('Nowa nazwa miejsca:', seat.title); if(title===null) return; const base = Number(prompt('Nowa cena wywoławcza (zł):', seat.basePrice)); if(Number.isFinite(base)) seat.basePrice = base; const durMin = Number(prompt('Czas trwania (minuty):', (seat.durationSec/60).toFixed(1))); if(Number.isFinite(durMin) && durMin>0){ seat.durationSec = Math.max(10, Math.round(durMin*60)); // if ongoing, restart timer to new duration
      if(seat.status==='ongoing'){ seat.endTime = Date.now() + seat.durationSec*1000; }
    }
    seat.title = title.trim() || seat.title; saveLocal(); await pushSeatsToServer(); render(); }

    // Separate change duration prompt (explicit)
    async function changeDurationPrompt(id){ const user = getCurrentUser(); if(!isAdmin(user)){ alert('Tylko administrator może zmieniać czas aukcji'); return; } const seat = seats.find(s=>s.id===id); if(!seat) return; const durMin = prompt('Ustaw nowy czas trwania (minuty). Uwaga: jeśli aukcja jest już trwająca, jej timer zostanie ustawiony na nowy czas (restart).', (seat.durationSec/60).toFixed(1)); if(durMin===null) return; const parsed = Number(durMin); if(!Number.isFinite(parsed) || parsed <= 0){ alert('Niepoprawna wartość'); return; } seat.durationSec = Math.max(10, Math.round(parsed*60)); if(seat.status==='ongoing'){ seat.endTime = Date.now() + seat.durationSec*1000; } saveLocal(); await pushSeatsToServer(); render(); }

    // --- PŁATNOŚCI (Stripe Checkout demo) ---
    // Frontend: po kliknięciu Zapłać wysyłamy POST /create-checkout-session { seatId }
    // Backend powinien utworzyć session w Stripe i zwrócić { url }

    async function startPayment(seatId){
      const seat = seats.find(s=>s.id===seatId);
      if(!seat){ alert('Nie znaleziono miejsca'); return; }
      if(!seat.highestBid || !seat.highestBidder){ alert('Brak zwycięzcy/kwoty'); return; }

      try{
        const res = await fetch('/create-checkout-session', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ seatId })
        });
        const data = await res.json();
        if(data.url){ window.location = data.url; }
        else if(data.error){ alert('Błąd tworzenia sesji płatności: ' + data.error); }
      }catch(e){ alert('Błąd sieci: ' + e.message); }
    }

    // synchronization: try server every 3s
    setInterval(()=>fetchSeatsFromServer(), 3000);

    // synchronizacja między kartami (localStorage)
    window.addEventListener('storage', (ev)=>{ if(ev.key === STORAGE_KEY){ try{ const remote = JSON.parse(ev.newValue || '[]'); seats = remote; render(); }catch(e){} } });

    // cykliczne sprawdzanie czasu (1s)
    setInterval(()=>{ const now = Date.now(); let changed = false; seats = seats.map(s => { if(s.status==='ongoing' && s.endTime && now>=s.endTime){ changed = true; return {...s, status:'ended'}; } return s; }); if(changed){ saveLocal(); pushSeatsToServer(); } render(); }, 1000);

    // --- add form handling ---
    document.getElementById('addForm').addEventListener('submit', async ev=>{ ev.preventDefault(); const user = getCurrentUser(); if(!isAdmin(user)){ document.getElementById('addErr').textContent = 'Tylko administrator może dodawać nowe licytacje.'; return; } const nameEl = document.getElementById('seatName'); const baseEl = document.getElementById('basePrice'); const durEl = document.getElementById('duration'); const name = nameEl.value.trim(); const base = Number(baseEl.value) || 0; const durMin = Number(durEl.value) || 1; if(base < 0){ document.getElementById('addErr').textContent = 'Cena wywoławcza musi być >= 0'; return; } if(durMin < 0.1){ document.getElementById('addErr').textContent = 'Czas trwania musi być co najmniej 0.1 minuty'; return; } const seat = { id: Date.now(), title: name || `Miejsce ${seats.length+1}`, basePrice: base, durationSec: Math.max(10, Math.round(durMin*60)), status: 'ready', highestBid:0, highestBidder:null, endTime:null }; seats.unshift(seat); saveLocal(); await pushSeatsToServer(); nameEl.value=''; baseEl.value='10'; durEl.value='2'; nameEl.focus(); render(); });

    // --- login modal handling ---
    const loginOverlay = document.getElementById('loginOverlay');
    const loginForm = document.getElementById('loginForm');
    const guestBtn = document.getElementById('guestBtn');

    loginForm.addEventListener('submit', ev=>{ ev.preventDefault(); const first = document.getElementById('firstName').value.trim(); const last = document.getElementById('lastName').value.trim(); if(!first || !last){ alert('Podaj imię i nazwisko'); return; } const user = { first, last }; setCurrentUser(user); loginOverlay.style.display = 'none'; render(); });
    guestBtn.addEventListener('click', ()=>{ // allow entering as guest (no admin rights)
      setCurrentUser({ first: 'Gość', last: '' }); loginOverlay.style.display = 'none'; render(); });

    // If user already present, hide login
    (async function init(){ const local = await loadSeatsLocal(); seats = local; // try to fetch from server initially
      await fetchSeatsFromServer(); const user = getCurrentUser(); if(user){ loginOverlay.style.display = 'none'; } else { loginOverlay.style.display = 'flex'; } render(); })();

    // initial render (fallback)
    render();
  </script>

  <!--
    BACKEND: przykładowy server.js (Node.js + Express) — obsługa /seats i Stripe Checkout
    -----------------------------------------------------------------
    Ten backend umożliwia synchronizację między komputerami (GET/POST /seats)
    oraz tworzenie sesji płatności Stripe (POST /create-checkout-session).

    Instalacja:
      npm init -y
      npm i express stripe body-parser dotenv

    .env:
      STRIPE_SECRET_KEY=sk_test_...
      DOMAIN=http://localhost:4242

    server.js (przykład):

    const express = require('express');
    const bodyParser = require('body-parser');
    const Stripe = require('stripe');
    require('dotenv').config();

    const stripe = Stripe(process.env.STRIPE_SECRET_KEY);
    const app = express();
    app.use(bodyParser.json());

    // prosty storage w pamieci — uzyj DB w produkcji
    let seats = [];

    app.get('/seats', (req,res)=>{
      res.json(seats);
    });

    app.post('/seats', (req,res)=>{
      seats = req.body;
      res.json({ok:true});
    });

    app.post('/create-checkout-session', async (req,res)=>{
      try{
        const { seatId } = req.body;
        const seat = seats.find(s=>s.id === seatId);
        if(!seat) return res.status(400).json({ error: 'Seat not found' });
        if(!seat.highestBid) return res.status(400).json({ error: 'No winning bid' });

        const domain = process.env.DOMAIN || 'http://localhost:4242';
        const session = await stripe.checkout.sessions.create({
          payment_method_types: ['card','blik'], // depends on your Stripe account
          mode: 'payment',
          line_items: [{
            price_data: { currency: 'pln', product_data: { name: seat.title }, unit_amount: Math.round(seat.highestBid * 100) },
            quantity: 1,
          }],
          success_url: `${domain}/success.html?session_id={CHECKOUT_SESSION_ID}`,
          cancel_url: `${domain}/cancel.html`,
          metadata: { seatId: String(seatId) }
        });

        res.json({ url: session.url });
      }catch(err){ console.error(err); res.status(500).json({ error: err.message }); }
    });

    // webhook do potwierdzenia platnosci (opcjonalnie)
    app.post('/webhook', bodyParser.raw({type: 'application/json'}), (req,res)=>{
      // implementuj verification i aktualizacje seats
      res.json({received:true});
    });

    app.listen(4242, ()=>console.log('Server running on http://localhost:4242'));

    UWAGI:
    - Uruchom backend na serwerze widocznym dla wszystkich maszyn, które mają widzieć aukcje.
    - W trybie testowym Stripe pozwala przetestować płatności bez prawdziwych kart.
    - Ten przykład używa Stripe jako "dowolnej innej" metody płatności — jeśli chcesz inny provider
      (PayPal, Przelewy24, Tpay), mogę przygotować odpowiedni endpoint.
  -->

</body>
</html>
